{% extends 'base.html' %}
{% block content %}
<div class="p-3">
  <div class="container">
    <div class="row mt-3">
      <div class="col mx-auto mb-3">
        <h2>Purchase Completed</h2>
        <hr />
        <p>Congratulations, purchase completed. Order number is: <b>#{{ template_data.order_id }}</b>
        </p>
        <div id="location-status" class="mt-3">
          <small class="text-muted">Capturing your location for analytics...</small>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const orderId = {{ template_data.order_id }};
    const locationStatus = document.getElementById('location-status');
    
    // Function to get location using browser's geolocation API
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const latitude = position.coords.latitude;
                    const longitude = position.coords.longitude;
                    
                    // Use reverse geocoding to get address information
                    reverseGeocode(latitude, longitude);
                },
                function(error) {
                    console.log('Geolocation error:', error);
                    locationStatus.innerHTML = '<small class="text-muted">Location capture failed (optional)</small>';
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000 // 5 minutes
                }
            );
        } else {
            locationStatus.innerHTML = '<small class="text-muted">Geolocation not supported</small>';
        }
    }
    
    // Function to reverse geocode coordinates to get address
    function reverseGeocode(lat, lng) {
        // Using a free reverse geocoding service (Nominatim)
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const address = data.address || {};
                const city = address.city || address.town || address.village || address.municipality || '';
                const state = address.state || address.province || address.region || '';
                const country = address.country || '';
                
                // Send location data to server
                updateOrderLocation(orderId, lat, lng, city, state, country);
            })
            .catch(error => {
                console.log('Reverse geocoding error:', error);
                // Still send coordinates even if reverse geocoding fails
                updateOrderLocation(orderId, lat, lng, '', '', '');
            });
    }
    
    // Function to send location data to server
    function updateOrderLocation(orderId, lat, lng, city, state, country) {
        fetch('{% url "cart.update_location" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({
                order_id: orderId,
                latitude: lat,
                longitude: lng,
                city: city,
                state: state,
                country: country
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                locationStatus.innerHTML = '<small class="text-success">Location captured successfully</small>';
            } else {
                locationStatus.innerHTML = '<small class="text-muted">Location capture failed (optional)</small>';
            }
        })
        .catch(error => {
            console.log('Location update error:', error);
            locationStatus.innerHTML = '<small class="text-muted">Location capture failed (optional)</small>';
        });
    }
    
    // Start location capture
    getLocation();
});
</script>
{% endblock content %}